<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POST</title>
    <!-- Include Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- Include Bootstrap DateTimePicker CSS -->
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/css/bootstrap-datetimepicker.min.css">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.4/jquery.min.js"></script>

    <!-- Include Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <!-- Include Bootstrap DateTimePicker JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <script
        src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-datetimepicker/4.17.47/js/bootstrap-datetimepicker.min.js"></script>

    <link rel="stylesheet" href="//code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
    <link rel="stylesheet" href="/resources/demos/style.css">
    <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.js"></script>

    <!-- bootstrap-toggle -->
    <link href="https://gitcdn.github.io/bootstrap-toggle/2.2.2/css/bootstrap-toggle.min.css" rel="stylesheet">
    <script src="https://gitcdn.github.io/bootstrap-toggle/2.2.2/js/bootstrap-toggle.min.js"></script>
</head>
<style>
    .lds-roller {
        display: block;
        position: relative;
        width: 80px;
        height: 80px;
    }

    .lds-roller div {
        animation: lds-roller 1.2s cubic-bezier(0.5, 0, 0.5, 1) infinite;
        transform-origin: 40px 40px;
    }

    .lds-roller div:after {
        content: " ";
        display: block;
        position: absolute;
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: #1ABB9C;
        margin: -4px 0 0 -4px;
    }

    .lds-roller div:nth-child(1) {
        animation-delay: -0.036s;
    }

    .lds-roller div:nth-child(1):after {
        top: 63px;
        left: 63px;
    }

    .lds-roller div:nth-child(2) {
        animation-delay: -0.072s;
    }

    .lds-roller div:nth-child(2):after {
        top: 68px;
        left: 56px;
    }

    .lds-roller div:nth-child(3) {
        animation-delay: -0.108s;
    }

    .lds-roller div:nth-child(3):after {
        top: 71px;
        left: 48px;
    }

    .lds-roller div:nth-child(4) {
        animation-delay: -0.144s;
    }

    .lds-roller div:nth-child(4):after {
        top: 72px;
        left: 40px;
    }

    .lds-roller div:nth-child(5) {
        animation-delay: -0.18s;
    }

    .lds-roller div:nth-child(5):after {
        top: 71px;
        left: 32px;
    }

    .lds-roller div:nth-child(6) {
        animation-delay: -0.216s;
    }

    .lds-roller div:nth-child(6):after {
        top: 68px;
        left: 24px;
    }

    .lds-roller div:nth-child(7) {
        animation-delay: -0.252s;
    }

    .lds-roller div:nth-child(7):after {
        top: 63px;
        left: 17px;
    }

    .lds-roller div:nth-child(8) {
        animation-delay: -0.288s;
    }

    .lds-roller div:nth-child(8):after {
        top: 56px;
        left: 12px;
    }

    @keyframes lds-roller {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }
</style>

<body>
    <!-- Modal loaddng -->
    <div class="modal fade in" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true" data-keyboard="false" data-backdrop="static">
        <div class="modal-dialog" role="document"
            style="display: flex; flex:1; justify-content: center; align-items: center; margin-top: 10%; background-color: #f1f1f1; width: 100px; height: 100px;">
            <div class="lds-roller">
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
                <div></div>
            </div>
        </div>
    </div>
    </style>
    <!-- Login facebook -->
    <fb:login-button id="login" config_id="686946062770243" onlogin="checkLoginState();"
        style="display: flex; justify-content: center; ">
    </fb:login-button>
    <!--  Thông tin POST  -->
    <div class="col-md-12 col-sm-12 col-xs-12" id="start" style="display: block; padding:10px">
        <!--  Tên, ảnh đại diện  -->
        <div
            style="flex:1;display:flex; flex-direction: row; align-items: center;background-color: #1ABB9C; border-radius: 3px; margin-bottom: 10px; padding: 5px; height: 60px;">
            <div style="display:flex; flex-direction: row; flex:0.2; align-items: center;">
                <img id="image_user" src="https://foodsources.com.sa/wp-content/uploads/2018/01/empty.png"
                    alt="Girl in a jacket" width="50" height="50" style="border-radius: 50px;">
                <p id="name_user" style="text-align: center;color:#fff; margin-top: 10px; margin-left: 10px;"></p>
            </div>
            <!--  Chọn Page  -->
            <select class="select" style="flex:0.3; border-radius: 5px;height: 40px" id="page">
            </select>
        </div>
        <!--  Khu vực form nhập  -->
        <div class="col-md-6 col-sm-6 col-xs-12">
            <h4 style="color:#1ABB9C; font-size:25px; font: bold;">THÔNG TIN BÀI VIẾT</h4>
            <!-- Tiêu đề bài viết -->
            <div class="form-group" style="display:flex; flex-direction: column">
                <label style="color: #ae4a20;">
                    Tiêu đề bài viết
                </label>
                <div>
                    <textarea type="text" id="txtContent" placeholder="Nhập Tiêu đề bài viết" class="form-control"
                        style="max-width: 500px; height: 80px; resize: none;"></textarea>
                </div>
            </div>
            <!--  Link ảnh -->
            <div class="form-group" style="display:flex; flex-direction: column">
                <label style="color: #ae4a20;">
                    Link ảnh <span style="color: red;">*</span>
                </label>
                <div>
                    <input type="text" id="txtLinkImage" placeholder="Nhập link ảnh" class="form-control"
                        style="max-width: 500px" />
                </div>
            </div>
            <!-- Comment -->
            <div class="form-group" style="display:flex; flex-direction: column">
                <label style="color: #ae4a20;">
                    Comment <span style="color: red;">*</span>
                </label>
                <div>
                    <input type="text" id="txtComment" placeholder="Nhập comment" class="form-control"
                        style="max-width: 500px" />
                </div>
            </div>

            <input type="file" id="fileInput" accept="image/*"> <!-- Input để chọn tệp ảnh -->
            <input type="text" id="urlInput" placeholder="Enter website URL">
            <button id="crawlButton" onclick="Crawl()">Crawl</button>

            <!-----  Đăng ngay - Lên lịch   ------>
            <div style="display: none; flex-direction: row; padding: 20px 0;">
                <label for="datetimepicker" style="margin-right: 10px; color:#ae4a20">Lên lịch cho bài đăng</label>
                <input type="checkbox" id="schedule" onclick="myFunction()" data-toggle="toggle" data-onstyle="success"
                    data-offstyle="danger" data-size="mini">
            </div>
            <!-- Ngày , giờ -->
            <div class="form-group" style="max-width: 500px; display: block;" id="date_time">
                <label for="datetimepicker">Chọn ngày - giờ</label>
                <div class="input-group date" id="datetimepicker">
                    <input type="text" class="form-control" id="txtDateTime" />
                    <span class="input-group-addon">
                        <span class="glyphicon glyphicon-calendar"></span>
                    </span>
                </div>
            </div>
            <!-- POST -->
            <div class="form-group">
                <button onclick="CreateImageID()"
                    style="display:flex; color:#fff; background-color: #4CAF50; padding: 10px 20px; border:none; border-radius: 5px; cursor: pointer;">
                    Post
                </button>
            </div>
        </div>
        <!-- Init login -->
        <script>
            $(document).ready(function () {
                $('#datetimepicker').datetimepicker({
                    format: 'DD-MM-YYYY HH:mm:ss',
                    defaultDate: new Date()
                });

            });
            // -----------------    Login-facebook   -------------------------// 
            var userID = "";
            var accessToken = "";
            var status = "";
            var accessTokenPage = "";
            var pageID = "";
            // Hàm chạy khi người dùng chưa đăng nhập
            function checkLoginState() {
                FB.getLoginStatus(function (response) {
                    status = response.status;
                    if (response.status === 'connected') {
                        document.getElementById('login').style.display = "none";
                        document.getElementById('start').style.display = "block";
                        //---------- lấy Tên, ảnh đại diện ---------------------//
                        FB.api(
                            '/me',
                            'GET',
                            { "fields": "name,picture" },
                            function (response) {
                                document.getElementById('name_user').innerText = response.name;
                                document.getElementById("image_user").src = response.picture.data.url;
                            }
                        );
                        // Lấy ID-USER
                        userID = response.authResponse.userID;
                        // Lấy mã truy cập ng dùng ngắn hạn (60 phút)
                        accessToken = response.authResponse.accessToken;
                        getTokenPage(userID, accessToken);
                    } else {
                        document.getElementById('login').style.display = "block";
                        document.getElementById('start').style.display = "none";
                    }
                });
            }
            // Khi người dùng đã đăng nhập mà chưa hết phiên
            window.fbAsyncInit = function () {
                FB.init({
                    appId: '1265578067484424',
                    autoLogAppEvents: true,
                    cookie: true,                     // Enable cookies to allow the server to access the session.
                    xfbml: true,                     // Parse social plugins on this webpage.
                    version: 'v16.0'                   // Use this Graph API version for this call.
                });
                // --- Check trạng thái đăng nhập ngay khi mới mở app lên ---------------------//
                FB.getLoginStatus(function (response) {   // See the onlogin handler
                    status = response.status;
                    if (response.status === 'connected') {
                        document.getElementById('login').style.display = "none";
                        document.getElementById('start').style.display = "block";
                        //---------- lấy Tên, ảnh đại diện ---------------------//
                        FB.api(
                            '/me',
                            'GET',
                            { "fields": "name,picture" },
                            function (response) {
                                document.getElementById('name_user').innerText = response.name;
                                document.getElementById("image_user").src = response.picture.data.url;
                            }
                        );
                        // Lấy ID-USER
                        userID = response.authResponse.userID;
                        // Lấy mã truy cập ng dùng ngắn hạn (60 phút)
                        accessToken = response.authResponse.accessToken;
                        getTokenPage(userID, accessToken);
                    } else {
                        document.getElementById('login').style.display = "block";
                        document.getElementById('start').style.display = "none";
                    }
                });
            };
            // ----------   Lấy danh sách trang truy cập Trang do bạn quản lý (lấy accesstoken của page)  ---------------------

            document.getElementById("page").onchange = function () {
                const string = document.getElementById("page").value.toString();
                accessTokenPage = string.substring(0, string.indexOf("[+]"));
                pageID = string.substring(string.indexOf("[+]") + 3);
            };

            // GET API
            async function getTokenPage(userID, shortToken) {
                const response = await fetch("https://graph.facebook.com/" + userID + "/accounts?fields= picture,name,access_token&access_token=" + accessToken);
                const jsonData = await response.json();
                jsonData.data.forEach(element => {
                    const z = document.createElement("option");
                    z.setAttribute("value", element.access_token + "[+]" + element.id);
                    const t = document.createTextNode(element.name);
                    z.appendChild(t);
                    document.getElementById("page").appendChild(z);
                });
                //Thêm vào option lựa chọn page
                const string = document.getElementById("page").value.toString();
                accessTokenPage = string.substring(0, string.indexOf("[+]"));
                pageID = string.substring(string.indexOf("[+]") + 3);
            }

        </script>
        <script>
            function Crawl() {
                $("#exampleModal").modal();
                const url = document.getElementById('urlInput').value.trim();
                fetch(`http://localhost:3000/crawl?url=${encodeURIComponent(url)}`)
                    .then(response => response.json())
                    .then(data => {
                        PostImageWP(data.title, data.body);
                    })
                    .catch(error => {
                        console.error('Error fetching data:', error);
                    });

                const fileInput = document.getElementById('fileInput');
                const file = fileInput.files[0];
                if (!file) {
                    alert('Please select an image file.');
                    return;
                }

                const URL_WEB = "https://testpost.bkafoods.com"
                const login = 'an123456';
                const password = 'an@123456';
                const basicAuth = 'Basic ' + btoa(login + ':' + password);



                async function PostImageWP(title, content) {
                    const formData = new FormData();
                    formData.append('file', file);
                    try {
                        const response = await fetch(URL_WEB + '/wp-json/wp/v2/media', {
                            method: 'POST',
                            headers: {
                                'Authorization': basicAuth,
                            },
                            body: formData,
                        });

                        if (response.ok) {
                            const responseData = await response.json();
                            if (responseData.id) {
                                const featuredImageId = responseData.id;
                                console.log('Featured image ID:', featuredImageId);
                                PostWP(responseData.link, responseData.id, title, content)
                            } else {
                                console.error('Failed to upload media:', responseData.link);
                            }
                        } else {
                            console.error('Failed to upload media:', response.statusText);
                        }
                    } catch (error) {
                        console.error('Error:', error);
                    }
                }


                // Đăng bài có hình ảnh nổi bật lên wordpress
                function PostWP(featuredImageLink, featuredImageId, title, content) {
                    const postData = {
                        title: title,
                        content: content,
                        status: 'publish',
                        featured_media: featuredImageId
                    };

                    fetch(URL_WEB + '/wp-json/wp/v2/posts', {
                        method: 'POST',
                        headers: {
                            'Authorization': basicAuth,
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(postData)
                    })
                        .then(response => {
                            if (response.ok) {
                                return response.json();
                            } else {
                                throw new Error('Failed to create post');
                            }
                        })
                        .then(data => {
                            console.log('Post created with ID:', data.link);
                            CreateImageID(featuredImageLink, data.link)

                        })
                        .catch(error => {
                            console.error('Error:', error.message);
                        });
                }
            }
        </script>

        <script>

            // -----------------    bootstrap-toggle   -------------------------//
            // var checkboxSchedule = true;
            // $('#schedule').change(function () {
            //     if ($(this).prop('checked')) {
            //         checkboxSchedule = true;
            //         document.getElementById('date_time').style.display = 'block'
            //     } else {
            //         checkboxSchedule = false;
            //         document.getElementById('date_time').style.display = 'none'
            //     }
            // });
            // Load the SDK asynchronously
            (function (d, s, id) {
                var js, fjs = d.getElementsByTagName(s)[0];
                if (d.getElementById(id)) return;
                js = d.createElement(s); js.id = id;
                js.src = "https://connect.facebook.net/en_US/sdk.js";
                fjs.parentNode.insertBefore(js, fjs);
            }(document, 'script', 'facebook-jssdk'));
            // ---------------------- POST ------------------------------//

            function CreateImageID(linkImage, comment) {
                 const message = document.getElementById('txtContent').value;
                // const linkImage = document.getElementById('txtLinkImage').value;
                // const comment = document.getElementById('txtComment').value;
                if (message.length != 0) {
                    // Đăng ảnh lên để lấy ID
                    FB.api(
                        '/' + pageID + '/photos',
                        'POST',
                        {
                            "url": linkImage,
                            "published": "false",
                            "access_token": accessTokenPage,
                        },
                        function (response) {
                            console.log("id hình ảnh: " + response.id);
                            setTimeout(POST_Feed_Image(response.id, message, comment), 3000);
                        }
                    );
                } else {
                    alert("Yêu cầu nhập đầy đủ thông tin")
                }


            }
            // Lên lịch cho bài đăng ảnh
            function POST_Feed_Image(imageID, message, comment) {
                const date_pick = document.getElementById('txtDateTime').value;
                var scheduledTime = new Date(date_pick.substring(6, 10), date_pick.substring(3, 5) - 1, date_pick.substring(0, 2), date_pick.substring(11, 13), date_pick.substring(14, 16), date_pick.substring(17, 19), 0).toISOString()
                FB.api(
                    '/' + pageID + '/feed',
                    'POST',
                    {
                        "message": message,
                        "attached_media": "[{\"media_fbid\":" + imageID + "}]",
                        "published": "false",
                        "scheduled_publish_time": (Math.floor(new Date(scheduledTime).getTime() / 1000)),
                        "access_token": accessTokenPage,
                    },
                    function (response) {
                        console.log("id bài viết " + response);
                        setTimeout(POST_Comment(response.id, comment), 3000);
                    }
                );
            }
            // POST COMMENT
            function POST_Comment(postID, comment) {
                FB.api(
                    '/v17.0/' + postID + '/comments',
                    'POST',
                    {
                        "message": comment,
                        "access_token": accessTokenPage
                    },
                    function (response) {
                        $("#exampleModal").modal('hide');
                        alert("Post id: " + postID)
                        document.getElementById('txtLinkImage').value = "";
                        document.getElementById('txtContent').value = "";
                        document.getElementById('txtComment').value = "";
                    }
                );
            }

        </script>

</body>

</html>